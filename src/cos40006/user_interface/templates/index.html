<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>AI Assistant Chat</h1>
        <div id="chat-container"></div>
        <form id="chat-form">
            <input type="text" id="user-input" name="user_input" placeholder="Type your message here..." required>
            <button type="submit">Send</button>
        </form>
        <button id="record-button">Hold to Talk</button>
        <p id="recording-status">Press and hold the button to start recording.</p>
        <div id="reminders-container">
            <h2>Reminders</h2>
            <ul id="reminders-list">
                {% for reminder in reminders %}
                    <li>{{ reminder }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let mediaRecorder;
            let audioChunks = [];

            $('#record-button').on('mousedown', function() {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();
                        audioChunks = [];

                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            const formData = new FormData();
                            formData.append('audio', audioBlob, 'speech.wav');

                            // Send the audio data to the backend
                            $.ajax({
                                url: '/process_audio',
                                method: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: function(response) {
                                    if (response.recognized_text) {
                                        $('#chat-container').append('<div class="assistant-message"><span>Recognized Speech:</span> ' + response.recognized_text + '</div>');
                                    } else {
                                        $('#chat-container').append('<div class="error-message">Error recognizing speech: ' + response.error + '</div>');
                                    }
                                },
                                error: function() {
                                    $('#chat-container').append('<div class="error-message">Error: Unable to process your audio.</div>');
                                }
                            });
                        };

                        $('#recording-status').text('Recording...');
                    })
                    .catch(error => {
                        console.error('Error accessing microphone:', error);
                    });
            });

            $('#record-button').on('mouseup', function() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    $('#recording-status').text('Press and hold the button to start recording.');
                }
            });
        });
    </script>
</body>
</html>
